<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
<link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAIDMASTER - Professional RAID Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        risk: '#DC2626',
                        assumption: '#2563EB',
                        issue: '#EA580C',
                        dependency: '#7C3AED',
                        p0: '#DC2626',
                        p1: '#EA580C',
                        p2: '#F59E0B',
                        p3: '#10B981'
                    }
                }
            }
        };
    </script>
    <style>
        .batch-select-mode .raid-card {
            transform: translateX(40px);
        }
        .batch-select-mode .batch-checkbox {
            opacity: 1;
            pointer-events: all;
        }
        .batch-checkbox {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .raid-card {
            transition: transform 0.2s ease-in-out;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-primary rounded flex items-center justify-center">
                        <span class="text-white font-bold text-sm">R</span>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">RAIDMASTER</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right">
                        <div class="text-xs text-gray-500 dark:text-gray-400">Total Items</div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white" id="totalItemsCount">4</div>
                    </div>
                    <button id="menuBtn" class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">
                        <span class="text-lg">‚ãÆ</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Search Bar -->
        <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Search RAID items..." class="w-full pl-10 pr-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="flex overflow-x-auto hide-scrollbar">
                <button class="tab-btn px-6 py-3 text-sm font-medium text-primary border-b-2 border-primary bg-primary/5" data-tab="raid">
                    RAID List
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-tab="matrix">
                    Risk Matrix
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-tab="timeline">
                    Timeline
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-tab="analytics">
                    Analytics
                </button>
                <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-tab="settings">
                    Settings
                </button>
            </div>
        </nav>

        <!-- Filter Chips -->
        <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3">
            <div class="flex space-x-2 overflow-x-auto hide-scrollbar" id="filterChips">
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="all">
                    All
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="risk">
                    Risks
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="assumption">
                    Assumptions
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="issue">
                    Issues
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="dependency">
                    Dependencies
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="P0">
                    P0
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="P1">
                    P1
                </button>
                <button class="filter-chip px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-filter="open">
                    Open
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden relative">
            <!-- RAID List View -->
            <div id="raidView" class="h-full overflow-y-auto">
                <!-- AI Analysis Button -->
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <button id="runAIAnalysisBtn" class="w-full bg-gradient-to-r from-primary to-purple-600 text-white py-3 px-4 rounded-lg font-medium hover:from-primary/90 hover:to-purple-600/90 transition-all duration-200 flex items-center justify-center shadow-md">
                        <span class="mr-2">‚ö°</span>
                        Run AI Analysis on All Items
                        <span class="ml-2 text-xs bg-white/20 px-2 py-1 rounded" id="aiAnalysisModelBadge">gpt-4o</span>
                    </button>
                </div>
                <div id="raidList" class="p-4 space-y-3"></div>
            </div>

            <!-- Risk Matrix View -->
            <div id="matrixView" class="h-full overflow-y-auto hidden">
                <div class="p-4">
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Risk Impact/Probability Matrix</h2>
                        <div class="flex items-center space-x-6 text-sm text-gray-600 dark:text-gray-400">
                            <div>Total Items: <span id="matrixTotal" class="font-medium">4</span></div>
                            <div>High Risk: <span id="matrixHighRisk" class="font-medium text-red-600 dark:text-red-400">2</span></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
                        <div class="grid grid-cols-4 gap-2">
                            <!-- Headers -->
                            <div></div>
                            <div class="text-center text-sm font-medium text-gray-700 dark:text-gray-300 py-2">Low</div>
                            <div class="text-center text-sm font-medium text-gray-700 dark:text-gray-300 py-2">Medium</div>
                            <div class="text-center text-sm font-medium text-gray-700 dark:text-gray-300 py-2">High</div>

                            <!-- High Probability Row -->
                            <div class="text-right text-sm font-medium text-gray-700 dark:text-gray-300 py-2">High</div>
                            <div class="matrix-cell bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 rounded p-4 text-center cursor-pointer hover:bg-yellow-200 dark:hover:bg-yellow-900/50 transition-colors" data-impact="low" data-probability="high">
                                <div class="matrix-count text-2xl font-bold text-yellow-800 dark:text-yellow-200">0</div>
                            </div>
                            <div class="matrix-cell bg-orange-100 dark:bg-orange-900/30 border border-orange-300 dark:border-orange-700 rounded p-4 text-center cursor-pointer hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors" data-impact="medium" data-probability="high">
                                <div class="matrix-count text-2xl font-bold text-orange-800 dark:text-orange-200">1</div>
                            </div>
                            <div class="matrix-cell bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded p-4 text-center cursor-pointer hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors" data-impact="high" data-probability="high">
                                <div class="matrix-count text-2xl font-bold text-red-800 dark:text-red-200">1</div>
                            </div>

                            <!-- Medium Probability Row -->
                            <div class="text-right text-sm font-medium text-gray-700 dark:text-gray-300 py-2">Medium</div>
                            <div class="matrix-cell bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded p-4 text-center cursor-pointer hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors" data-impact="low" data-probability="medium">
                                <div class="matrix-count text-2xl font-bold text-green-800 dark:text-green-200">0</div>
                            </div>
                            <div class="matrix-cell bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 rounded p-4 text-center cursor-pointer hover:bg-yellow-200 dark:hover:bg-yellow-900/50 transition-colors" data-impact="medium" data-probability="medium">
                                <div class="matrix-count text-2xl font-bold text-yellow-800 dark:text-yellow-200">2</div>
                            </div>
                            <div class="matrix-cell bg-orange-100 dark:bg-orange-900/30 border border-orange-300 dark:border-orange-700 rounded p-4 text-center cursor-pointer hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors" data-impact="high" data-probability="medium">
                                <div class="matrix-count text-2xl font-bold text-orange-800 dark:text-orange-200">0</div>
                            </div>

                            <!-- Low Probability Row -->
                            <div class="text-right text-sm font-medium text-gray-700 dark:text-gray-300 py-2">Low</div>
                            <div class="matrix-cell bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded p-4 text-center cursor-pointer hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors" data-impact="low" data-probability="low">
                                <div class="matrix-count text-2xl font-bold text-green-800 dark:text-green-200">0</div>
                            </div>
                            <div class="matrix-cell bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded p-4 text-center cursor-pointer hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors" data-impact="medium" data-probability="low">
                                <div class="matrix-count text-2xl font-bold text-green-800 dark:text-green-200">1</div>
                            </div>
                            <div class="matrix-cell bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 rounded p-4 text-center cursor-pointer hover:bg-yellow-200 dark:hover:bg-yellow-900/50 transition-colors" data-impact="high" data-probability="low">
                                <div class="matrix-count text-2xl font-bold text-yellow-800 dark:text-yellow-200">0</div>
                            </div>
                        </div>

                        <div class="mt-6 text-center">
                            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Impact ‚Üí</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Probability ‚Üë</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline View -->
            <div id="timelineView" class="h-full overflow-y-auto hidden">
                <div class="p-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">RAID Timeline</h2>
                    <div id="timelineContent" class="space-y-4"></div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="h-full overflow-y-auto hidden">
                <div class="p-4 space-y-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Analytics Dashboard</h2>
                    
                    <!-- Executive Summary Button -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">AI Executive Summary</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Get comprehensive insights on your RAID items</p>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 dark:text-gray-400">Using AI Model</div>
                                <div class="text-sm font-medium text-primary" id="summaryAIModel">Claude-Sonnet-4</div>
                            </div>
                        </div>
                        
                        <button id="generateSummaryBtn" class="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors flex items-center justify-center">
                            <span class="mr-2">‚ö°</span>
                            Generate AI Executive Summary
                        </button>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                            <div class="text-2xl font-bold text-gray-900 dark:text-white" id="totalItemsStat">4</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Total Items</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="highPriorityStat">2</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">P0/P1 Items</div>
                        </div>
                    </div>

                    <!-- Distribution Charts -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Type Distribution</h3>
                        <div id="typeDistribution" class="space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="h-full overflow-y-auto hidden">
                <div class="p-4 space-y-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Settings</h2>
                    
                    <!-- AI Configuration -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">AI Configuration</h3>
                        
                        <div class="space-y-4">
                            <!-- AI Provider Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI Provider</label>
                                <select id="aiProviderSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="OpenAI">OpenAI</option>
                                    <option value="Anthropic">Anthropic</option>
                                    <option value="Gemini">Google Gemini</option>
                                </select>
                            </div>

                            <!-- AI Model Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">AI Model</label>
                                <select id="aiModelSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="gpt-4o">GPT-4o (Recommended)</option>
                                    <option value="gpt-4o-mini">GPT-4o-mini (Cost Effective)</option>
                                </select>
                            </div>

                            <!-- API Key Configuration -->
                            <div id="apiKeySection">
                                <div class="mb-2">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">API Key (Required)</label>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter your AI provider's API key to enable AI features</p>
                                </div>
                                <div id="apiKeyInput">
                                    <input type="password" id="apiKeyField" placeholder="Enter your API key..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent mb-2">
                                    <p class="text-xs text-gray-500 dark:text-gray-400">API keys are stored locally and never sent to our servers</p>
                                </div>
                            </div>

                            <!-- Auto Apply -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Auto-apply AI suggestions</label>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">When confidence is high</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoApplyToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 dark:peer-focus:ring-primary/20 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                                </label>
                            </div>

                            <!-- Confidence Threshold -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confidence Threshold</label>
                                <input type="range" id="confidenceSlider" min="0" max="1" step="0.1" value="0.8" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <span>0%</span>
                                    <span id="confidenceValue">80%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <!-- Usage Stats -->
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Usage Statistics</h4>
                                <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                    <div>Total AI Calls: <span id="totalCalls">0</span></div>
                                    <div>API Calls: <span id="apiCalls">0</span></div>
                                    <div>Last Reset: <span id="lastReset">Never</span></div>
                                </div>
                                <button id="resetStats" class="mt-2 text-xs text-primary hover:text-primary/80">Reset Statistics</button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Data Management</h3>
                        
                        <div class="space-y-3">
                            <button id="clearAllData" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors">
                                Clear All Data
                            </button>
                            <button id="resetToDefaults" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition-colors">
                                Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Action Button -->
        <button id="fab" class="fixed bottom-6 right-6 w-14 h-14 bg-primary text-white rounded-full shadow-lg hover:bg-primary/90 transition-all duration-200 flex items-center justify-center z-30">
            <span class="text-2xl">+</span>
        </button>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global State
        let currentTab = 'raid';
        let currentFilter = 'all';
        let searchQuery = '';
        let batchSelectMode = false;
        let selectedItems = [];

        // AI Configuration with provider-specific API keys
        let aiConfig = {
            model: 'gpt-4o',
            provider: 'OpenAI',
            autoApply: false,
            confidenceThreshold: 0.8,
            usageStats: {
                totalCalls: 0,
                apiCalls: 0,
                lastReset: null
            }
        };

        // Provider-specific API keys (saved separately)
        let apiKeys = {
            'OpenAI': '',
            'Anthropic': '',
            'Gemini': ''
        };

        // AI Providers configuration
        const aiProviders = {
            'OpenAI': {
                name: 'OpenAI',
                endpoint: 'https://api.openai.com/v1/chat/completions',
                models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo']
            },
            'Anthropic': {
                name: 'Anthropic', 
                endpoint: 'https://api.anthropic.com/v1/messages',
                models: ['claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022', 'claude-3-opus-20240229']
            },
            'Gemini': {
                name: 'Google Gemini',
                endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent',
                models: ['gemini-1.5-pro', 'gemini-1.5-flash', 'gemini-1.0-pro']
            }
        };

        // Storage keys
        const STORAGE_KEYS = {
            RAID_ITEMS: 'raidmaster_items',
            AI_CONFIG: 'raidmaster_ai_config',
            API_KEYS: 'raidmaster_api_keys'
        };

        // Storage functions
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.warn('Failed to save to localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage(key, defaultValue = null) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch (error) {
                console.warn('Failed to load from localStorage:', error);
                return defaultValue;
            }
        }

        function saveData() {
            saveToLocalStorage(STORAGE_KEYS.RAID_ITEMS, raidItems);
            saveToLocalStorage(STORAGE_KEYS.AI_CONFIG, aiConfig);
            saveToLocalStorage(STORAGE_KEYS.API_KEYS, apiKeys);
        }

        function loadSavedData() {
            // Load AI config
            const savedAiConfig = loadFromLocalStorage(STORAGE_KEYS.AI_CONFIG);
            if (savedAiConfig) {
                aiConfig = { ...aiConfig, ...savedAiConfig };
            }

            // Load API keys
            const savedApiKeys = loadFromLocalStorage(STORAGE_KEYS.API_KEYS);
            if (savedApiKeys) {
                apiKeys = { ...apiKeys, ...savedApiKeys };
            }

            // Load RAID items
            const savedItems = loadFromLocalStorage(STORAGE_KEYS.RAID_ITEMS);
            if (savedItems && Array.isArray(savedItems)) {
                raidItems.length = 0;
                raidItems.push(...savedItems);
            }
        }

        // Enhanced RAID Items with proper data structure
        let raidItems = [
            {
                id: 1,
                type: 'risk',
                title: 'Third-party API may be deprecated',
                description: 'The payment provider we depend on has announced potential API changes. Timeline: Q2 2024. Impact: All payment flows. Mitigation: Evaluate alternative providers',
                status: 'Open',
                priority: 'P1',
                impact: 'high',
                probability: 'medium',
                workstream: 'Engineering',
                owner: 'John Doe',
                dueDate: '2024-01-15',
                createdAt: '2024-01-10T10:00:00Z',
                updatedAt: '2024-01-12T14:30:00Z',
                aiAnalysis: {
                    suggestedPriority: 'P1',
                    suggestedStatus: 'In Progress',
                    confidence: 0.85,
                    flags: ['potential-blocker', 'requires-approval'],
                    rationale: 'High impact on core payment functionality with medium probability. Requires immediate attention to evaluate alternatives.',
                    lastAnalyzedAt: '2024-01-12T14:30:00Z'
                },
                history: []
            },
            {
                id: 2,
                type: 'assumption',
                title: 'Users will adopt new interface quickly',
                description: 'Assuming users will transition to the new UI within 30 days based on previous rollout patterns and user feedback from beta testing.',
                status: 'Open',
                priority: 'P2',
                impact: 'medium',
                probability: 'medium',
                workstream: 'Product',
                owner: 'Jane Smith',
                dueDate: '2024-01-20',
                createdAt: '2024-01-08T09:15:00Z',
                updatedAt: '2024-01-10T11:45:00Z',
                aiAnalysis: null,
                history: []
            },
            {
                id: 3,
                type: 'issue',
                title: 'Performance degradation in search functionality',
                description: 'Search response times increased by 40% in the last week affecting ~10,000 daily users. Database query optimization needed.',
                status: 'In Progress',
                priority: 'P0',
                impact: 'critical',
                probability: 'high',
                workstream: 'Engineering',
                owner: 'Mike Johnson',
                dueDate: '2024-01-12',
                createdAt: '2024-01-09T16:20:00Z',
                updatedAt: '2024-01-11T13:15:00Z',
                aiAnalysis: {
                    suggestedPriority: 'P0',
                    suggestedStatus: 'In Progress',
                    confidence: 0.95,
                    flags: ['performance-critical', 'user-impact', 'requires-hotfix'],
                    rationale: 'Critical performance degradation affecting large user base. Immediate action required to prevent further user churn.',
                    lastAnalyzedAt: '2024-01-11T13:15:00Z'
                },
                history: []
            },
            {
                id: 4,
                type: 'dependency',
                title: 'Legal approval for data processing changes',
                description: 'Waiting for legal team approval on new data processing procedures including GDPR compliance review and data retention policy updates.',
                status: 'Open',
                priority: 'P2',
                impact: 'medium',
                probability: 'low',
                workstream: 'Legal',
                owner: 'Lisa Garcia',
                dueDate: '2024-01-25',
                createdAt: '2024-01-05T14:00:00Z',
                updatedAt: '2024-01-08T10:30:00Z',
                aiAnalysis: null,
                history: []
            }
        ];

        // Custom alert and confirm functions
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <button class="w-full px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors" onclick="document.body.removeChild(this.closest('.fixed'))">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="document.body.removeChild(this.closest('.fixed'))">Cancel</button>
                        <button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded" onclick="document.body.removeChild(this.closest('.fixed')); (${onConfirm})()">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function addRaidItem(formData) {
            const newItem = {
                id: Date.now(),
                type: formData.type,
                title: formData.title,
                description: formData.description || '',
                status: formData.status || 'Open',
                priority: formData.priority || 'P2',
                impact: formData.impact || 'medium',
                probability: formData.probability || 'medium',
                workstream: formData.workstream || 'General',
                owner: formData.owner || 'Current User',
                dueDate: formData.dueDate || null,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                aiAnalysis: null,
                history: []
            };

            raidItems.unshift(newItem);
            updateCounts();
            
            if (currentTab === 'raid') {
                renderRaidList();
            } else if (currentTab === 'matrix') {
                updateMatrixCounts();
            }
            
            showToast('RAID item added successfully');
        }

        function openCreateItemModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end justify-center';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-t-xl p-6 transform translate-y-full transition-transform duration-300 max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Add RAID Item</h2>
                        <button class="close-modal p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <span class="text-lg">‚úï</span>
                        </button>
                    </div>
                    
                    <form id="createForm" class="space-y-4">
                        <!-- Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type</label>
                            <select id="itemType" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="risk">Risk</option>
                                <option value="assumption">Assumption</option>
                                <option value="issue">Issue</option>
                                <option value="dependency">Dependency</option>
                            </select>
                        </div>

                        <!-- Title -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title</label>
                            <input type="text" id="itemTitle" required class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter item title...">
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                            <textarea id="itemDescription" rows="3" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Describe the item..."></textarea>
                        </div>

                        <!-- Priority -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
                            <select id="itemPriority" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="P0">P0 - Critical</option>
                                <option value="P1">P1 - High</option>
                                <option value="P2" selected>P2 - Medium</option>
                                <option value="P3">P3 - Low</option>
                            </select>
                        </div>

                        <!-- Impact -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Impact</label>
                            <select id="itemImpact" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>

                        <!-- Probability -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Probability</label>
                            <select id="itemProbability" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>

                        <!-- Owner -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Owner</label>
                            <input type="text" id="itemOwner" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Assign owner...">
                        </div>

                        <!-- Workstream -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Workstream</label>
                            <input type="text" id="itemWorkstream" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter workstream...">
                        </div>

                        <!-- Due Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Due Date</label>
                            <input type="date" id="itemDueDate" class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>

                        <!-- Actions -->
                        <div class="flex space-x-3 pt-4 mt-6 border-t border-gray-200 dark:border-gray-700">
                            <button type="button" class="cancel-create flex-1 px-4 py-3 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
                                Create Item
                            </button>
                        </div>
                    </form>
                </div>
            `;

            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.querySelector('.bg-white').style.transform = 'translateY(100%)';
                setTimeout(() => document.body.removeChild(modal), 300);
            });

            modal.querySelector('.cancel-create').addEventListener('click', () => {
                modal.querySelector('.bg-white').style.transform = 'translateY(100%)';
                setTimeout(() => document.body.removeChild(modal), 300);
            });

            modal.querySelector('#createForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const formData = {
                    type: modal.querySelector('#itemType').value,
                    title: modal.querySelector('#itemTitle').value.trim(),
                    description: modal.querySelector('#itemDescription').value.trim(),
                    priority: modal.querySelector('#itemPriority').value,
                    impact: modal.querySelector('#itemImpact').value,
                    probability: modal.querySelector('#itemProbability').value,
                    owner: modal.querySelector('#itemOwner').value.trim(),
                    workstream: modal.querySelector('#itemWorkstream').value.trim(),
                    dueDate: modal.querySelector('#itemDueDate').value || null
                };

                if (!formData.title) {
                    showAlert('Please enter a title for the RAID item');
                    return;
                }

                addRaidItem(formData);
                
                modal.querySelector('.bg-white').style.transform = 'translateY(100%)';
                setTimeout(() => document.body.removeChild(modal), 300);
            });

            document.body.appendChild(modal);
            setTimeout(() => {
                modal.querySelector('.bg-white').style.transform = 'translateY(0)';
            }, 10);
        }

        function updateCounts() {
            const total = raidItems.length;
            document.getElementById('totalItemsCount').textContent = total;
            if (document.getElementById('totalItemsStat')) {
                document.getElementById('totalItemsStat').textContent = total;
            }
            if (document.getElementById('highPriorityStat')) {
                document.getElementById('highPriorityStat').textContent = raidItems.filter(i => ['P0', 'P1'].includes(i.priority)).length;
            }
        }

        function renderRaidList() {
            const container = document.getElementById('raidList');
            const filtered = filterRaidItems(raidItems);
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 text-gray-400 mx-auto mb-4 text-4xl">üì•</div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No RAID items found</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Get started by creating your first RAID item</p>
                        <button onclick="openCreateItemModal()" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primary/90 transition-colors">
                            Create RAID Item
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => createRaidCard(item)).join('');
        }

        function createRaidCard(item) {
            const typeColors = {
                risk: 'bg-risk',
                assumption: 'bg-assumption',
                issue: 'bg-issue',
                dependency: 'bg-dependency'
            };

            const priorityColors = {
                P0: 'bg-p0',
                P1: 'bg-p1',
                P2: 'bg-p2',
                P3: 'bg-p3'
            };

            const statusColors = {
                'Open': 'bg-blue-500',
                'In Progress': 'bg-indigo-500',
                'Mitigating': 'bg-indigo-500',
                'Resolved': 'bg-green-500',
                'Closed': 'bg-green-500',
                'Archived': 'bg-gray-500'
            };

            return `
                <div class="raid-card relative bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-4 hover:shadow-md transition-all duration-200 cursor-pointer" 
                     onclick="openItemDetail(${item.id})">

                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white ${typeColors[item.type]}">
                                ${item.type.charAt(0).toUpperCase() + item.type.slice(1)}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white ${priorityColors[item.priority]}">
                                ${item.priority}
                            </span>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-white ${statusColors[item.status]}">
                            ${item.status}
                        </span>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 line-clamp-2">${item.title}</h3>
                    
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-3 line-clamp-2">${item.description}</p>
                    
                    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                        <div class="flex items-center space-x-4">
                            <span>üë§ ${item.owner}</span>
                            <span>üìÅ ${item.workstream}</span>
                        </div>
                        ${item.dueDate ? `<span class="text-gray-500 dark:text-gray-400">üìÖ ${formatDate(item.dueDate)}</span>` : ''}
                    </div>
                    
                    ${item.aiAnalysis ? `
                    <div class="mt-3 flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span class="text-xs text-green-600 dark:text-green-400">AI Analyzed (${Math.round((item.aiAnalysis.confidence || 0) * 100)}%)</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function filterRaidItems(items) {
            return items.filter(item => {
                // Filter by type/priority/status
                if (currentFilter !== 'all') {
                    if (!['open', 'closed', 'resolved'].includes(currentFilter.toLowerCase())) {
                        // Type or priority filter
                        if (item.type !== currentFilter && item.priority !== currentFilter) {
                            return false;
                        }
                    } else {
                        // Status filter
                        if (item.status.toLowerCase().replace(' ', '') !== currentFilter) {
                            return false;
                        }
                    }
                }
                
                // Search filter
                if (searchQuery) {
                    const searchText = `${item.title} ${item.description} ${item.owner} ${item.workstream}`.toLowerCase();
                    return searchText.includes(searchQuery);
                }
                
                return true;
            });
        }

        function updateMatrixCounts() {
            const matrix = {};
            
            // Initialize matrix
            ['low', 'medium', 'high'].forEach(prob => {
                matrix[prob] = {};
                ['low', 'medium', 'high', 'critical'].forEach(impact => {
                    matrix[prob][impact] = 0;
                });
            });

            // Count items in each cell
            raidItems.forEach(item => {
                if (item.impact && item.probability) {
                    const impact = item.impact === 'critical' ? 'high' : item.impact; // Map critical to high for matrix
                    matrix[item.probability][impact]++;
                }
            });

            // Update UI
            document.querySelectorAll('.matrix-cell').forEach(cell => {
                const impact = cell.dataset.impact;
                const probability = cell.dataset.probability;
                const count = matrix[probability][impact] || 0;
                cell.querySelector('.matrix-count').textContent = count;
            });

            // Update summary
            const total = raidItems.length;
            const highRisk = raidItems.filter(item => 
                (item.impact === 'high' || item.impact === 'critical') && 
                (item.probability === 'medium' || item.probability === 'high')
            ).length;

            document.getElementById('matrixTotal').textContent = total;
            document.getElementById('matrixHighRisk').textContent = highRisk;
        }

        function renderTimeline() {
            const container = document.getElementById('timelineContent');
            const sortedItems = [...raidItems].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            if (sortedItems.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400">No timeline data available</div>';
                return;
            }

            container.innerHTML = sortedItems.map(item => `
                <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600 p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-900 dark:text-white">${item.title}</h3>
                        <span class="text-sm text-gray-500 dark:text-gray-400">${formatDate(item.updatedAt)}</span>
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white bg-${item.type === 'risk' ? 'risk' : item.type === 'assumption' ? 'assumption' : item.type === 'issue' ? 'issue' : 'dependency'}">
                            ${item.type.charAt(0).toUpperCase() + item.type.slice(1)}
                        </span>
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium text-white bg-${item.priority === 'P0' ? 'p0' : item.priority === 'P1' ? 'p1' : item.priority === 'P2' ? 'p2' : 'p3'}">
                            ${item.priority}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${item.description.substring(0, 120)}...</p>
                </div>
            `).join('');
        }

        function renderAnalytics() {
            // Update type distribution
            const typeDistribution = document.getElementById('typeDistribution');
            const total = raidItems.length;
            
            if (total === 0) {
                typeDistribution.innerHTML = '<div class="text-center py-4 text-gray-500 dark:text-gray-400">No data to display</div>';
                return;
            }

            const types = ['risk', 'assumption', 'issue', 'dependency'];
            const typeColors = ['bg-risk', 'bg-assumption', 'bg-issue', 'bg-dependency'];
            
            typeDistribution.innerHTML = types.map((type, index) => {
                const count = raidItems.filter(item => item.type === type).length;
                const percentage = Math.round((count / total) * 100);
                
                return `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 rounded ${typeColors[index]}"></div>
                            <span class="text-sm text-gray-700 dark:text-gray-300">${type.charAt(0).toUpperCase() + type.slice(1)}s</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-900 dark:text-white">${count}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">(${percentage}%)</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openItemDetail(itemId) {
            const item = raidItems.find(i => i.id === itemId);
            if (!item) return;
            
            showAlert(`Item Details: ${item.title}\n\nType: ${item.type}\nPriority: ${item.priority}\nStatus: ${item.status}\nOwner: ${item.owner}\nDescription: ${item.description}`);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (error) {
                return dateString;
            }
        }

        // Initialize the app
        function initApp() {
            console.log('üöÄ Initializing RAIDMASTER...');
            
            // Load saved data first
            loadSavedData();
            
            // Update UI with current AI model
            const aiAnalysisBadge = document.getElementById('aiAnalysisModelBadge');
            if (aiAnalysisBadge) {
                aiAnalysisBadge.textContent = aiConfig.model;
            }
            
            const summaryAIModel = document.getElementById('summaryAIModel');
            if (summaryAIModel) {
                summaryAIModel.textContent = aiConfig.model;
            }
            
            updateCounts();
            renderRaidList();
            
            // Set up event listeners
            setupTabNavigation();
            setupFilterChips();
            setupSearchInput();
            setupFAB();
            setupBasicSettings();
            setupMenuButton();
            setupSettingsPanel();
            setupAIAnalysisButton();
            
            // Initialize settings display
            updateSettingsDisplay();
            
            console.log('‚úÖ RAIDMASTER initialized successfully');
        }

        function setupAIAnalysisButton() {
            const runAIAnalysisBtn = document.getElementById('runAIAnalysisBtn');
            if (runAIAnalysisBtn) {
                runAIAnalysisBtn.addEventListener('click', () => {
                    runAIAnalysis();
                });
            }

            // Setup Generate Summary button
            const generateSummaryBtn = document.getElementById('generateSummaryBtn');
            if (generateSummaryBtn) {
                generateSummaryBtn.addEventListener('click', () => {
                    generateExecutiveSummary();
                });
            }
        }

        function setupTabNavigation() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchTab(tab);
                });
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-primary', 'border-b-2', 'border-primary', 'bg-primary/5');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-500', 'dark:text-gray-400');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('text-primary', 'border-b-2', 'border-primary', 'bg-primary/5');
            
            // Hide all views
            document.querySelectorAll('[id$="View"]').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show selected view
            document.getElementById(`${tab}View`).classList.remove('hidden');
            
            // Initialize view-specific content
            if (tab === 'matrix') {
                updateMatrixCounts();
            } else if (tab === 'timeline') {
                renderTimeline();
            } else if (tab === 'analytics') {
                renderAnalytics();
            }
        }

        function setupFilterChips() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    currentFilter = chip.dataset.filter;
                    
                    // Update chip styles
                    document.querySelectorAll('.filter-chip').forEach(c => {
                        c.classList.remove('bg-primary', 'text-white');
                        c.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    
                    chip.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    chip.classList.add('bg-primary', 'text-white');
                    
                    renderRaidList();
                });
            });
        }

        function setupSearchInput() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderRaidList();
            });
        }

        function setupFAB() {
            document.getElementById('fab').addEventListener('click', () => {
                openCreateItemModal();
            });
        }

        function setupBasicSettings() {
            // Clear all data
            const clearAllData = document.getElementById('clearAllData');
            if (clearAllData) {
                clearAllData.addEventListener('click', () => {
                    showConfirm('Are you sure you want to clear all RAID items?', () => {
                        raidItems.length = 0;
                        updateCounts();
                        renderRaidList();
                        saveData();
                        showToast('All data cleared');
                    });
                });
            }

            // Reset to defaults
            const resetToDefaults = document.getElementById('resetToDefaults');
            if (resetToDefaults) {
                resetToDefaults.addEventListener('click', () => {
                    showConfirm('Reset all items to default examples?', () => {
                        location.reload();
                    });
                });
            }
        }

        // Menu functionality
        let isMenuOpen = false;

        function setupMenuButton() {
            document.getElementById('menuBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (isMenuOpen) {
                    closeDropdownMenu();
                } else {
                    openDropdownMenu();
                }
            });
        }

        function openDropdownMenu() {
            const existingMenu = document.getElementById('dropdownMenu');
            if (existingMenu) {
                document.body.removeChild(existingMenu);
            }

            const menu = document.createElement('div');
            menu.id = 'dropdownMenu';
            menu.className = 'fixed top-16 right-4 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-600 py-2 z-50 min-w-64 max-w-xs opacity-0 scale-95 transform transition-all duration-200';
            
            menu.innerHTML = `
                <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="font-semibold text-gray-900 dark:text-white">Actions</h3>
                </div>
                
                <button id="runAIAnalysisMenu" class="w-full px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                    <span class="text-xl">‚ö°</span>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">Run AI Analysis</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Analyze all RAID items with AI</div>
                    </div>
                </button>

                <button id="exportData" class="w-full px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                    <span class="text-xl">üì•</span>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">Export Data</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Download JSON</div>
                    </div>
                </button>
                
                <button id="refreshData" class="w-full px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors flex items-center space-x-3">
                    <span class="text-xl">üîÑ</span>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">Refresh</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Reload RAID items</div>
                    </div>
                </button>
            `;

            // Add event listeners
            menu.querySelector('#runAIAnalysisMenu').addEventListener('click', () => {
                closeDropdownMenu();
                runAIAnalysis();
            });

            menu.querySelector('#exportData').addEventListener('click', () => {
                closeDropdownMenu();
                exportData();
            });

            menu.querySelector('#refreshData').addEventListener('click', () => {
                closeDropdownMenu();
                triggerRefresh();
            });

            document.body.appendChild(menu);
            
            // Animate in
            setTimeout(() => {
                menu.style.opacity = '1';
                menu.style.transform = 'scale(1)';
            }, 10);
            
            isMenuOpen = true;

            // Close menu when clicking outside
            const closeOnOutsideClick = (e) => {
                if (!menu.contains(e.target) && !document.getElementById('menuBtn').contains(e.target)) {
                    closeDropdownMenu();
                    document.removeEventListener('click', closeOnOutsideClick);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeOnOutsideClick);
            }, 100);
        }

        function closeDropdownMenu() {
            const menu = document.getElementById('dropdownMenu');
            if (menu) {
                menu.style.opacity = '0';
                menu.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                }, 200);
            }
            isMenuOpen = false;
        }

        // AI Functions
        async function runAIAnalysis() {
            if (raidItems.length === 0) {
                showAlert('No RAID items to analyze');
                return;
            }

            const currentApiKey = apiKeys[aiConfig.provider];
            if (!currentApiKey || !currentApiKey.trim()) {
                showAlert(`Please configure your ${aiConfig.provider} API key in Settings to use AI features.`);
                return;
            }

            showLoadingModal('Running AI Analysis...');
            
            try {
                const analysisPrompt = `Analyze these RAID items and provide priority/status recommendations. Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`).

Items to analyze:
${JSON.stringify(raidItems.map(item => ({
    id: item.id,
    type: item.type,
    title: item.title,
    description: item.description,
    priority: item.priority,
    status: item.status,
    impact: item.impact,
    probability: item.probability,
    dueDate: item.dueDate,
    workstream: item.workstream
})), null, 2)}

Return JSON array with objects containing:
- id: item ID
- suggestedPriority: "P0"|"P1"|"P2"|"P3"  
- suggestedStatus: current status or recommended change
- confidence: number 0-1 (confidence in analysis)
- rationale: brief explanation
- flags: array of concern flags ["urgent", "blocking", "unclear", "overdue", etc.]

Analysis criteria:
- P0: Business critical, immediate action required
- P1: High impact, resolve within days  
- P2: Medium impact, planned resolution
- P3: Low impact, backlog item`;

                const analysisResponse = await callAI(analysisPrompt);
                hideLoadingModal();
                
                if (analysisResponse && analysisResponse.trim()) {
                    try {
                        const analysisResults = JSON.parse(analysisResponse);
                        
                        // Apply analysis results to items
                        analysisResults.forEach(result => {
                            const item = raidItems.find(i => i.id == result.id);
                            if (item) {
                                item.aiAnalysis = {
                                    suggestedPriority: result.suggestedPriority,
                                    suggestedStatus: result.suggestedStatus,
                                    confidence: result.confidence,
                                    flags: result.flags || [],
                                    rationale: result.rationale,
                                    lastAnalyzedAt: new Date().toISOString()
                                };
                                
                                item.updatedAt = new Date().toISOString();
                                
                                // Auto-apply if high confidence and enabled
                                if (aiConfig.autoApply && (result.confidence || 0) >= aiConfig.confidenceThreshold) {
                                    item.priority = result.suggestedPriority;
                                    if (result.suggestedStatus && result.suggestedStatus !== item.status) {
                                        item.status = result.suggestedStatus;
                                    }
                                }
                            }
                        });
                        
                        // Update usage stats
                        aiConfig.usageStats.totalCalls++;
                        aiConfig.usageStats.apiCalls++;
                        saveData();
                        
                        // Refresh views
                        if (currentTab === 'raid') {
                            renderRaidList();
                        } else if (currentTab === 'matrix') {
                            updateMatrixCounts();
                        }
                        
                        showToast(`AI analysis completed on ${raidItems.length} items by ${aiConfig.model}`);
                        
                    } catch (parseError) {
                        console.error('Error parsing AI analysis results:', parseError);
                        showAlert('Failed to parse AI analysis results. Please try again.');
                    }
                } else {
                    throw new Error('AI returned empty response');
                }
                
            } catch (error) {
                hideLoadingModal();
                console.error("AI Analysis failed:", error);
                
                if (error.message === 'CORS_ERROR') {
                    showCORSErrorModal();
                } else {
                    showAlert(`AI analysis failed: ${error.message}`);
                }
            }
        }

        async function callAI(prompt) {
            const provider = aiProviders[aiConfig.provider];
            const apiKey = apiKeys[aiConfig.provider];
            
            if (!provider || !apiKey) {
                throw new Error(`Provider ${aiConfig.provider} or API key not configured`);
            }

            let headers = {};
            let requestBody = {};
            let endpoint = provider.endpoint;

            // Build request based on provider
            if (aiConfig.provider === 'OpenAI') {
                headers = {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                };
                requestBody = {
                    model: aiConfig.model,
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 4000,
                    temperature: 0.1
                };
            } else if (aiConfig.provider === 'Anthropic') {
                headers = {
                    'x-api-key': apiKey,
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                };
                requestBody = {
                    model: aiConfig.model,
                    max_tokens: 4000,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.1
                };
            } else if (aiConfig.provider === 'Gemini') {
                endpoint = provider.endpoint.replace('{model}', aiConfig.model);
                endpoint += `?key=${apiKey}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                requestBody = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 4000,
                        temperature: 0.1
                    }
                };
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed: ${response.status} ${errorText}`);
                }

                const data = await response.json();
                
                // Extract response based on provider
                let content = '';
                if (aiConfig.provider === 'OpenAI') {
                    content = data.choices[0].message.content;
                } else if (aiConfig.provider === 'Anthropic') {
                    content = data.content[0].text;
                } else if (aiConfig.provider === 'Gemini') {
                    content = data.candidates[0].content.parts[0].text;
                }
                
                return content;
            } catch (error) {
                // Handle CORS and network errors
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    throw new Error('CORS_ERROR');
                }
                throw error;
            }
        }

        function showLoadingModal(message = 'Processing...') {
            const modal = document.createElement('div');
            modal.id = 'loadingModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-sm w-full mx-4">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                            <span class="text-white text-xl">‚ö°</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">AI Processing</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${message}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full animate-pulse" style="width: 60%"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function hideLoadingModal() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function showCORSErrorModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">AI Features Not Available</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                AI analysis cannot run when opening this HTML file directly in your browser due to CORS (Cross-Origin Resource Sharing) security restrictions.
                            </p>
                            
                            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
                                <h4 class="text-sm font-semibold text-blue-900 dark:text-blue-100 mb-2">üí° Solutions:</h4>
                                <ul class="text-xs text-blue-800 dark:text-blue-200 space-y-1">
                                    <li><strong>1. Use on Poe:</strong> Upload this app to Poe's Canvas for full AI functionality</li>
                                    <li><strong>2. Local Server:</strong> Run <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">python -m http.server 8000</code> and open <code class="bg-blue-100 dark:bg-blue-800 px-1 rounded">localhost:8000</code></li>
                                    <li><strong>3. Browser Extensions:</strong> Install a CORS-disabling extension (not recommended for regular browsing)</li>
                                </ul>
                            </div>
                            
                            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                                <p class="text-xs text-green-800 dark:text-green-200">
                                    <strong>‚úÖ All other features work perfectly:</strong> Create, edit, filter, search, export RAID items, view analytics, and more!
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button class="px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors" onclick="document.body.removeChild(this.closest('.fixed'))">
                            Got it
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Generate Executive Summary
        async function generateExecutiveSummary() {
            if (raidItems.length === 0) {
                showAlert('No RAID items available for summary generation');
                return;
            }

            const currentApiKey = apiKeys[aiConfig.provider];
            if (!currentApiKey || !currentApiKey.trim()) {
                showAlert(`Please configure your ${aiConfig.provider} API key in Settings to use AI features.`);
                return;
            }

            showLoadingModal('Generating Executive Summary...');
            
            try {
                const summaryPrompt = `Generate a comprehensive executive summary report for these RAID (Risks, Assumptions, Issues, Dependencies) items. Focus on strategic insights and actionable recommendations for leadership.

RAID Portfolio Data:
${JSON.stringify(raidItems.map(item => ({
    type: item.type,
    title: item.title,
    description: item.description,
    priority: item.priority,
    status: item.status,
    impact: item.impact,
    probability: item.probability,
    workstream: item.workstream,
    owner: item.owner,
    dueDate: item.dueDate,
    aiAnalysis: item.aiAnalysis
})), null, 2)}

Please provide a structured executive summary covering:

1. **Executive Overview** - High-level portfolio health and key concerns
2. **Risk Assessment** - Critical risks requiring immediate attention
3. **Priority Breakdown** - Distribution and focus areas by priority levels
4. **Workstream Analysis** - Team/department exposure and workload
5. **Timeline Concerns** - Overdue items and upcoming deadlines
6. **Strategic Recommendations** - Concrete next steps for leadership
7. **Resource Implications** - Staffing and budget considerations

Format the response in clear, professional language suitable for executive consumption. Use bullet points for key items and include specific metrics where relevant.`;

                const summaryResponse = await callAI(summaryPrompt);
                hideLoadingModal();
                
                if (summaryResponse && summaryResponse.trim()) {
                    // Update usage stats
                    aiConfig.usageStats.totalCalls++;
                    aiConfig.usageStats.apiCalls++;
                    saveData();
                    
                    showExecutiveSummaryModal(summaryResponse);
                } else {
                    throw new Error('AI returned empty response');
                }
                
            } catch (error) {
                hideLoadingModal();
                console.error("Executive Summary failed:", error);
                
                if (error.message === 'CORS_ERROR') {
                    showCORSErrorModal();
                } else {
                    showAlert(`Executive summary failed: ${error.message}`);
                }
            }
        }

        function showExecutiveSummaryModal(summaryText) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                <span class="text-white text-lg">üìä</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 dark:text-white">AI Executive Summary</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Generated by ${aiConfig.model} ‚Ä¢ ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="copySummary" class="px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                üìã Copy
                            </button>
                            <button class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" onclick="document.body.removeChild(this.closest('.fixed'))">
                                <span class="text-lg">‚úï</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6">
                        <div class="prose dark:prose-invert max-w-none">
                            <div id="summaryContent" class="whitespace-pre-wrap text-sm leading-relaxed text-gray-700 dark:text-gray-300">${summaryText}</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end p-6 border-t border-gray-200 dark:border-gray-700 space-x-3">
                        <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" onclick="document.body.removeChild(this.closest('.fixed'))">
                            Close
                        </button>
                        <button id="exportSummary" class="px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
                            üì• Export as PDF
                        </button>
                    </div>
                </div>
            `;

            // Add event listeners
            modal.querySelector('#copySummary').addEventListener('click', () => {
                navigator.clipboard.writeText(summaryText).then(() => {
                    showToast('Summary copied to clipboard');
                }).catch(() => {
                    showToast('Failed to copy to clipboard');
                });
            });

            modal.querySelector('#exportSummary').addEventListener('click', () => {
                exportSummaryAsText(summaryText);
            });

            document.body.appendChild(modal);
        }

        function exportSummaryAsText(summaryText) {
            const date = new Date().toISOString().split('T')[0];
            const filename = `raid-executive-summary-${date}.txt`;
            
            const content = `RAID EXECUTIVE SUMMARY
Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
AI Model: ${aiConfig.model}
Total Items: ${raidItems.length}

${summaryText}

---
Generated by RAIDMASTER AI Assistant
`;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Executive summary exported successfully');
        }

        function exportData() {
            const data = JSON.stringify(raidItems, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raid-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully');
        }

        function triggerRefresh() {
            updateCounts();
            renderRaidList();
            showToast('Data refreshed');
        }

        // Settings functionality
        function setupSettingsPanel() {
            // AI Provider selection
            const aiProviderSelect = document.getElementById('aiProviderSelect');
            if (aiProviderSelect) {
                aiProviderSelect.addEventListener('change', (e) => {
                    aiConfig.provider = e.target.value;
                    updateModelOptions();
                    updateAPIKeyField();
                    saveData();
                    showToast(`AI provider changed to ${aiConfig.provider}`);
                });
            }

            // AI Model selection
            const aiModelSelect = document.getElementById('aiModelSelect');
            if (aiModelSelect) {
                aiModelSelect.addEventListener('change', (e) => {
                    aiConfig.model = e.target.value;
                    
                    // Update all AI model displays
                    const aiAnalysisBadge = document.getElementById('aiAnalysisModelBadge');
                    if (aiAnalysisBadge) aiAnalysisBadge.textContent = aiConfig.model;
                    
                    const summaryAIModel = document.getElementById('summaryAIModel');
                    if (summaryAIModel) summaryAIModel.textContent = aiConfig.model;
                    
                    saveData();
                    showToast(`AI model changed to ${aiConfig.model}`);
                });
            }

            // API Key input
            const apiKeyField = document.getElementById('apiKeyField');
            if (apiKeyField) {
                apiKeyField.addEventListener('change', (e) => {
                    apiKeys[aiConfig.provider] = e.target.value.trim();
                    saveData();
                    showToast('API key updated');
                });
            }

            // Auto-apply toggle
            const autoApplyToggle = document.getElementById('autoApplyToggle');
            if (autoApplyToggle) {
                autoApplyToggle.addEventListener('change', (e) => {
                    aiConfig.autoApply = e.target.checked;
                    saveData();
                    showToast(`Auto-apply ${aiConfig.autoApply ? 'enabled' : 'disabled'}`);
                });
            }

            // Confidence threshold
            const confidenceSlider = document.getElementById('confidenceSlider');
            if (confidenceSlider) {
                confidenceSlider.addEventListener('input', (e) => {
                    aiConfig.confidenceThreshold = parseFloat(e.target.value);
                    const confidenceValue = document.getElementById('confidenceValue');
                    if (confidenceValue) {
                        confidenceValue.textContent = `${Math.round(aiConfig.confidenceThreshold * 100)}%`;
                    }
                    saveData();
                });
            }

            // Reset stats
            const resetStats = document.getElementById('resetStats');
            if (resetStats) {
                resetStats.addEventListener('click', () => {
                    aiConfig.usageStats = {
                        totalCalls: 0,
                        apiCalls: 0,
                        lastReset: new Date().toISOString()
                    };
                    saveData();
                    updateUsageStatsDisplay();
                    showToast('Usage statistics reset');
                });
            }
        }

        function updateModelOptions() {
            const provider = aiProviders[aiConfig.provider];
            const modelSelect = document.getElementById('aiModelSelect');
            
            if (provider && provider.models && modelSelect) {
                modelSelect.innerHTML = provider.models.map(model => 
                    `<option value="${model}" ${model === aiConfig.model ? 'selected' : ''}>${model}</option>`
                ).join('');
                
                // Update model if current one is not available
                if (!provider.models.includes(aiConfig.model)) {
                    aiConfig.model = provider.models[0];
                    modelSelect.value = aiConfig.model;
                }
            }
        }

        function updateAPIKeyField() {
            const apiKeyField = document.getElementById('apiKeyField');
            if (apiKeyField) {
                apiKeyField.value = apiKeys[aiConfig.provider] || '';
            }
        }

        function updateUsageStatsDisplay() {
            const totalCallsEl = document.getElementById('totalCalls');
            const apiCallsEl = document.getElementById('apiCalls');
            const lastResetEl = document.getElementById('lastReset');
            
            if (totalCallsEl) totalCallsEl.textContent = aiConfig.usageStats.totalCalls;
            if (apiCallsEl) apiCallsEl.textContent = aiConfig.usageStats.apiCalls || 0;
            if (lastResetEl) lastResetEl.textContent = aiConfig.usageStats.lastReset ? 
                formatDate(aiConfig.usageStats.lastReset) : 'Never';
        }

        function updateSettingsDisplay() {
            const aiProviderSelect = document.getElementById('aiProviderSelect');
            if (aiProviderSelect) aiProviderSelect.value = aiConfig.provider;
            
            const aiModelSelect = document.getElementById('aiModelSelect');
            if (aiModelSelect) aiModelSelect.value = aiConfig.model;
            
            const autoApplyToggle = document.getElementById('autoApplyToggle');
            if (autoApplyToggle) autoApplyToggle.checked = aiConfig.autoApply;
            
            const confidenceSlider = document.getElementById('confidenceSlider');
            if (confidenceSlider) confidenceSlider.value = aiConfig.confidenceThreshold;
            
            const confidenceValue = document.getElementById('confidenceValue');
            if (confidenceValue) confidenceValue.textContent = `${Math.round(aiConfig.confidenceThreshold * 100)}%`;
            
            updateModelOptions();
            updateAPIKeyField();
            updateUsageStatsDisplay();
        }

        // Make functions globally available
        window.openItemDetail = openItemDetail;
        window.openCreateItemModal = openCreateItemModal;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('üìö RAIDMASTER script loaded successfully');
                initApp();
            } catch (error) {
                console.error('Initialization failed:', error);
                showAlert('App failed to initialize. Please refresh the page.');
            }
        });
    </script>


</body></html>